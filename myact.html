<html>
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QM71F063G7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-QM71F063G7');
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-act.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32-act.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16-act.png">
<link rel="manifest" href="/site-act.webmanifest">
<!------------------------------------------------------------------>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
<!-- Google Fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
<!-- Bootstrap core CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
<!-- Material Design Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet">

<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css" rel="stylesheet">
<!------------------------------------------------------------------>

<link href="font/css/open-iconic-bootstrap.css" rel="stylesheet">
<title>MyACT</title>
<style>
.progress { height: 2px;}

@media screen and (max-width: 767px){
#map {
 width: auto;
 height: calc(var(--vh, 1vh)*100 - 30px);
 border:1px solid #aaa;
}
#qrvinfo {
 width: auto;
 height: calc(var(--vh, 1vh)*100 - 30px);
 overflow:auto;
 border:1px solid #aaa;
 -webkit-overflow-scrolling:touch;
 }
}
@media screen and (min-width: 768px) {
#map {
 width: auto;
 height:calc(var(--vh, 1vh)*100 - 56px);
 border:1px solid #aaa;
 }
#qrvinfo {
 width: auto;
 height: calc(var(--vh, 1vh)*100 - 56px);
 overflow:auto;
 border:1px solid #aaa;
 -webkit-overflow-scrolling:touch;
 }
}
.modal-header {
    padding-top: 2px;
    height: 34px;
    padding-bottom: 2px;
}
.modal-footer {
    padding-top: 2px;
    height: 24px;
    padding-bottom: 2px;
}
.modal-body > .img-responsive {
    margin-left: auto;
    margin-right: auto;
}
.slider.slider-horizontal {
    width:100px !important;
}
.navbar-dark .navbar-toggler {
border-color: rgba(0,0,0,0);
}
.navbar-toggler-icon {
font-size: 0.8em;
}
.collapse.in {
 height: auto;
}

i.semantic-ui-custom {
  margin-top: 9px;
}
@keyframes blink {
  50% { opacity: 0.3; }
}
@-webkit-keyframes blink {
  50% { opacity: 0.3; }
}
.blink-me {
  animation: blink 1s linear infinite;
  -webkit-animation: blink 1s linear infinite;
}

.btn {
 margin: 0.1rem !important ; padding: 0.4rem 0.5rem !important;
}

.my-tooltip-label {
    color: white;	
    background: transparent;
    border: none;
    box-shadow: none;
    font-size: 8px;
}

</style>
</head>
<body>
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script> 
<!---------------------------------------------------------------------->
<!-- JQuery -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap tooltips -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>
<!-- Chart JS plugins -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.2.1/chart.umd.min.js" integrity="sha512-GCiwmzA0bNGVsp1otzTJ4LWQT2jjGJENLGyLlerlzckNI30moi2EQT0AfRI7fLYYYDKR+7hnuh35r3y1uJzugw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<!------------------------------------------------------------------------>
<!-- plugin -->
<link rel="stylesheet" href="css/leaflet.extra-markers.min.css" />
<script src="js/leaflet.extra-markers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.3.1/dist/semantic.min.css">
<link rel="stylesheet" href="js/L.Control.ZoomLabel.css">
<script src="js/L.Control.ZoomLabel.js"></script>
<script src="js/regionfill.js"></script>
<script src="js/getDEM.js"></script>
<script src="js/actzone.js"></script>
<script src="js/search-ref.js"></script>
<!-- plugin -->

  <nav class="navbar navbar-expand-md navbar-dark bg-dark text-light">
    <span class="navbar-brand" style="cursor: hand;cursor: pointer;"><h4>MyACT</h4></span>
    <button type="button" class="btn btn-amber" onClick="clickQTHButton()" title="現在位置を調べる"><span class="fas fa-map-marked-alt" ></span></button>
    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#spots-data" title="最新スポットを表示"><span class="fas fa-satellite-dish"></span></button>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-prefs" title="設定"><span class="fas fa-cog"></span></button>
    
    <div id="search_ref"></div>
    <script>
      $("#search_ref").searchinput({width:65,done:function(s){showReference(s)}})
    </script>

    <small><span id="clock_time" style="cursor: default;" ></span></small>
  </nav>
  
  <div class = "modal fade" id="spots-data">
    <div class="modal-dialog" style="max-width: 90%;margin:1rem auto;">
      <div class="modal-content">
	<div class="modal-header">
	  <div class="dropdown">
	    <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false" id="program_dropdown">
	      SOTA/POTA
	    </button>
	    <div class="dropdown-menu">
	      <a class="dropdown-item" href="javascript:onProgChange(0);"><small>SOTA/POTA</small></a>
	      <a class="dropdown-item" href="javascript:onProgChange(1);"><small>SOTA</small></a>
	      <a class="dropdown-item" href="javascript:onProgChange(2);"><small>POTA</small></a>
	    </div>
	  </div>
	  <div class="dropdown">
	  <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false" id="period_dropdown">
	    Last 6H
	  </button>
	  <div class="dropdown-menu">
	    <a class="dropdown-item" href="javascript:onPeriodChange(1);"><small>1</small></a>
	    <a class="dropdown-item" href="javascript:onPeriodChange(3);"><small>3</small></a>
	    <a class="dropdown-item" href="javascript:onPeriodChange(6);"><small>6</small></a>
	    <a class="dropdown-item" href="javascript:onPeriodChange(9);"><small>9</small></a>
	    <a class="dropdown-item" href="javascript:onPeriodChange(12);"><small>12</small></a>
	    <a class="dropdown-item" href="javascript:onPeriodChange(15);"><small>15</small></a>
	    <a class="dropdown-item" href="javascript:onPeriodChange(18);"><small>18</small></a>
	    <a class="dropdown-item" href="javascript:onPeriodChange(21);"><small>21</small></a>
	    <a class="dropdown-item" href="javascript:onPeriodChange(24);"><small>24</small></a>
	  </div>
	</div>
	<div class="custom-control custom-checkbox">
	    <input class="custom-control-input" type="checkbox" value="" id="by_call" onclick="clickPrefs();refresh_spots()">
	    <label class="custom-control-label" for="by_call"><small>By Callsign</small></label>
	  </div>
	  <small><span id="clock_time2" style="cursor: default;" ></span></small>
	</div>
	<div id="chart-container" class="modal-body">
	  <canvas id="myChart"></canvas>
	</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" onClick="closePrefs()">Close</button>
      </div>
    </div>
  </div>
  
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
	<div id="map"></div>
      </div>
    </div>
  </div>
  <div class="modal" id="modal-prefs" tabindex="-1" role="dialog" aria-labelledby="staticModalLabel" aria-hidden="true" data-show="true" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title"><b>Preferences</b></h4>
        </div><!-- /modal-header -->
        <div class="modal-body">
	  <div class ="form-group">
	    <label class="control-label"><u>表示対象</u></label>
	    <div class="custom-control custom-checkbox">
	      <input class="custom-control-input" type="checkbox" value="" id="sota_ref" onclick="clickPrefs()">
	      <label class="custom-control-label" for="sota_ref">SOTA</label>
	    </div>
	    <div class="custom-control custom-checkbox">
	      <input class="custom-control-input" type="checkbox" value="" id="pota_ref" onclick="clickPrefs()">
	      <label class="custom-control-label" for="pota_ref">POTA</label>
	    </div>
	    <div class="custom-control custom-checkbox">
	      <input class="custom-control-input" type="checkbox" value="" id="jaff_ref" onclick="clickPrefs()">
	      <label class="custom-control-label" for="jaff_ref">JAFF</label>
	    </div>
	  </div>
	  <div class ="form-group">
	    <label class="control-label"><u>マーカ</u></label>
	    <p>表示する数:&nbsp&nbsp<b>多</b>&nbsp&nbsp&nbsp
	      <input id="zoom-threshold" data-slider-id='ex1Slider' type="text" data-slider-min="9" data-slider-max="12" data-slider-step="1" data-slider-value="12"/>&nbsp&nbsp&nbsp&nbsp<b>少</b>
	    </p>
	    <div class="custom-control custom-checkbox">
	      <input class="custom-control-input" type="checkbox" value="" id="popup_permanent" onclick="clickPrefs()">
	      <label class="custom-control-label" for="popup_permanent"> 公園名を常に表示</label>
	    </div>
	    <div class="custom-control custom-checkbox">
	      <input class="custom-control-input" type="checkbox" value="" id="link_googlemap" onclick="clickPrefs()">
	      <label class="custom-control-label" for="link_googlemap"> Google Mapにリンク</label>
	    </div>
	    <div class="custom-control custom-checkbox">
	      <input class="custom-control-input" type="checkbox" value="" id="display_mapcode" onclick="clickPrefs()">
	      <label class="custom-control-label" for="display_mapcode"> MAPCODEを表示<br><small>(「マップコード」および「MAPCODE」は㈱デンソーの登録商標です)</small></label>
	    </div>
	    <!--
	    <label class="control-label"><u>スポット表示期間</u></label>
	    <p><b>短</b>&nbsp&nbsp&nbsp
	      <input id="spot-period" data-slider-id='ex2Slider' type="text" data-slider-min="3" data-slider-max="24" data-slider-step="1" data-slider-value="3"/>&nbsp&nbsp&nbsp&nbsp<b>長</b>
	    </p>
	    -->
	  </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal" onClick="closePrefs()">Close</button>
          </div>
	</div> <!-- /.modal-content -->
      </div> <!-- /.modal-dialog -->
    </div> <!-- /.modal -->
  </div>
</body>
<!-- Optional JavaScript -->
<style type="text/css">
    i.semantic-ui-custom {
        margin-top: 9px;
    }
</style>

<script>
let vh = window.innerHeight * 0.01;
document.documentElement.style.setProperty('--vh', `${vh}px`);
window.addEventListener('resize',()=> {
let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
});

var sotalive = 'https://www.sotalive.net/';
var gsi = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>|<a href='https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-A10-v4_1.html' target='_blank'>国土数値情報自然公園地域データ</a>"
});

var map = L.map('map',{
    layers: [ gsi ]
});
L.control.scale().addTo(map);
L.control.zoomLabel().addTo(map);
var popup = L.popup();

var last_area = null;
var last_mesg = '';
var geomagindex = 'A:-- K:-';
  
function redrawPopup() {
    if (last_area != null) {
	var ctnt = '<b>' + selectRef(last_area, true) + '</b>' + last_mesg;
	popup.setContent(ctnt);
	popup.update();
    }
}

function locURI(lat, lng, zoom) {
    var gsiuri= 'https://maps.gsi.go.jp/',
	googleuri = 'https://www.google.com/maps/@?api=1&map_action=map&';
    
    if (prefs['link_googlemap']) {
	return googleuri + 'center=' + lat + ',' + lng + '&zoom=' + zoom + '&basemap=satellite';
    } else {
	return gsiuri + '#' + zoom + '/' + lat + '/' + lng;
    }
}

function displayPopup(area, latlng, isMarker, isGPS) {
    var lat = Math.round(latlng.lat * 1000000,4)/1000000,
	lng = Math.round(latlng.lng * 1000000,4)/1000000,
	z = map.getZoom();

    if ( z > 11)
	wz = 11
    else
	wz = z;
    
    var windyuri = 'https://www.windy.com/?'+ latlng.lat + ',' + latlng.lng + ',' + wz + ',d:picker';

    if (isGPS) {
	Cookies.set('my_qth_lat',lat)
	Cookies.set('my_qth_lng',lng)
    }
  
    var resfun = function(res) {
	if ('alt' in latlng) {
	    altitude = res['elevation'] + 'm (GPS測位値:'+latlng.alt+'m)';
	} else {
	    altitude = res['elevation'] + 'm';	    
	}
	
	if (res['errors'] == 'OUTSIDE_JA') {
	    mesg = 'Pos: ' + lat +','+ lng + '<br>GL: '+res['maidenhead'];
        }
	else if (res['errors'] != 'OK') {
 	    mesg = 'Parameter out of range.';
	} else {
	    accu = '<small>[' + res['hsrc'].replace('（','').replace('）','') + ']</small>'

	    if (isGPS)
		pos = '<br>位置:<a href="' + locURI(lat, lng, z) + '" target="_blank">' + lat + ',' + lng +'</a>';
	    else
		pos = '<i><br>位置:<a href="' + locURI(lat, lng, z) + '" target="_blank">'  + lat + ',' + lng +'</a></i>';
	    
	    if (res['type'] == 'JCC') {
			if (res['ward'] != undefined)
			    mesg = 'JCC'+res['jcc']+ ' 区番号:' + res['ward'] + '<br>' + res['pref'] + res['addr2'] + res['addr1'] + '<br>GL:' + res['maidenhead'] + pos + '<br> 標高:' + altitude;
			else
			    mesg = 'JCC'+res['jcc']+ '<br>' + res['pref'] + res['addr2'] + res['addr1'] + '<br>GL:' + res['maidenhead'] + pos + '<br> 標高:' + altitude;
		}
		else
		    mesg = 'JCG'+res['jcg']+ res['hamlog']+ '<br>' + res['pref'] + res['addr2'] + res['addr1']+ '<br>GL:' + res['maidenhead'] + pos + '<br> 標高:' + altitude;
	}
	
	if (prefs['display_mapcode']) 
	    mapcode = '<br><img src="img/mc_long.jpg" height=14px> &nbsp' + res['mapcode'];
	else
	    mapcode = '';

	weather= '&nbsp&nbsp<a href="' + windyuri +'" target="_blank"><img src="svg/sun.svg"><img src="svg/cloud.svg"><img src="svg/rain.svg"></a>' + mapcode;
	
	if (isMarker) {
	    mesg = '<h4>' + mesg + weather + '</h4>';
	    if (qth_marker != null)
		qth_marker.bindPopup(mesg).openPopup();
	} else {
	    cnt = selectRef(area, true);
	    if (cnt != '')
		cnt = '<b>' + cnt + '</b>' + mesg + weather;
	    else
		cnt = mesg + weather;
	    popup.setContent(cnt);
	    popup.setLatLng(latlng).openOn(map);
	    last_area = area;
	    last_mesg = mesg;
	}
    }
    
    var resfun2 = function(res) {
	if (res['errors'] == 'OK') {
	    s = res['summits'][0]
	    l = {'lat':s['lat'],'lng':s['lon']}
	    displayActivationZone(l, -0.8);
	} 
    }
    
    $.getJSON(sotalive+'api/reverse-geocoder/LonLatToAddressElevMapCode?','lat='+latlng.lat+'&lon='+latlng.lng,resfun);

    $.getJSON(sotalive+'api/sotasummits/JA?','&lat='+latlng.lat+'&lon='+latlng.lng+"&srange=300", resfun2);
}

var prefs =
    { 'popup_permanent': true,
      'display_mapcode': false,
      'link_googlemap': false, 
      'zoom_threshold': 12,
      'spot_period': 6,
      'by_call': false,
      'sota_ref': true,
      'pota_ref': true,
      'jaff_ref': true
    }

$('#zoom-threshold').slider({
    formatter: function(value) {
	prefs['zoom_threshold'] = Number(value);
	return '全ての公園を表示するズームレベル ' + value;
    }
});

$('#spot-period').slider({
    formatter: function(value) {
	prefs['spot_period'] = Number(value);
	return '最新' + value + "時間を表示";
    }
});
   
function clickPrefs() {
    for(var k in prefs) {
	if (k == 'zoom_threshold' || k == 'spot_period') {
	}
	else {
	    var el = document.getElementById(k);
	    if (el.checked == true) {
		prefs[k] = true;
		Cookies.set(k, 'true',{expires: 180, SameSite:'Lax'})
	    } else {
		prefs[k] = false;
		Cookies.set(k, 'false',{expires: 180, SameSite:'Lax'})
	    }
	}
    }
}

function readCookie(pref) {
    for (var k in pref) {
	var ck = Cookies.get(k);
	if (k == 'zoom_threshold') {
	    if (ck  == undefined) {
		ck = '12';
		Cookies.set(k, ck,{expires: 180, SameSite:'Lax'});
	    }
	    else
		pref[k] = Number(ck)
	    $('#zoom-threshold').slider('setValue',Number(ck))
	}
	else if (k == 'spot_period') {
	    if (ck  == undefined) {
		ck = '6';
		Cookies.set(k, ck,{expires: 180, SameSite:'Lax'});
	    }
	    else
		pref[k] = Number(ck)
	    $('#spot-period').slider('setValue',Number(ck))
	}
	else {
	    if (ck  == undefined) {
		if (pref[k])
		    Cookies.set(k, 'true',{expires: 180, SameSite:'Lax'})
		else
		    Cookies.set(k, 'false',{expires: 180, SameSite:'Lax'})
	    } else {
		if (ck == 'true')
		    pref[k] = true
		else
		    pref[k] = false
	    }
	    var el = document.getElementById(k);
	    if (pref[k])
		el.checked = true
	    else
		el.checked = false;
	}
    }
}

function closePrefs() {
    Cookies.set('zoom_threshold',String(prefs['zoom_threshold']),{expires: 180, SameSite:'Lax'})
    Cookies.set('spot_period',String(prefs['spot_period']),{expires: 180, SameSite:'Lax'})
    redrawPopup();
    redrawMarkers();
    refresh_spots();
}

readCookie(prefs);

  function selectRef(area, addhref) {
  var pname = '';

  if (area['pota'] == undefined || area['jaff'] == undefined)
	return '';

  if (area['pota'] != '' && prefs['pota_ref']) {
      if (addhref) 
	  pname = '<a target="_blank" href="https://pota.app/#/park/'+ area['pota'] + '">' + area['pota'] + '</a> '
      else
	  pname = area['pota'];
      
      if (area['jaff'] != '' && prefs['jaff_ref']) {
	  if (addhref)
	      pname += '/' + '<a target="_blank" href="https://wwff.co/directory/?showRef='+ area['jaff'] + '">' + area['jaff'] + '</a> '
	  else 
	      pname += '/' + area['jaff'];
      }
  } else if (prefs['jaff_ref']) {
	  if (addhref)
	      pname = '<a target="_blank" href="https://wwff.co/directory/?showRef='+ area['jaff'] + '">' + area['jaff'] + '</a> '
	  else 
	      pname = area['jaff']
  }
  
  if (pname != '' && area['name'] != '') {
      pname += '<br>'
      pname += area['name']
  }
    
  if (pname != '')
      pname = '<div style="text-align:center">' + pname + '</div>';

  return pname;
}
   
qth_marker = null

function QTHdragend(e) {
    var latlng = e.target.getLatLng();
    map.setView(latlng, 15); 
    displayPopup({}, latlng, true, false);
}

function callbkQTHOk(arg) {
    var crd = arg.coords,
        latlng = [crd.latitude, crd.longitude],
	options = {
        prefix: 'icon'
        ,icon: 'user'
        ,shape: 'circle'
        ,markerColor: 'yellow'
        ,extraClasses: 'semantic-ui-custom'
	};
 
    if (false && crd.altitude != null) {
	r_alt = Math.round(crd.altitude*100)/100;
	gps_pos = {lat:crd.latitude, lng:crd.longitude, alt:r_alt };
    }
    else
	gps_pos = {lat:crd.latitude, lng:crd.longitude};
    
    map.setView(latlng, 15);

    if (qth_marker != null)
	map.removeLayer(qth_marker)
	    
    qth_marker = L.marker(latlng,
			  {draggable:true, icon: L.ExtraMarkers.icon(options)});

    qth_marker.addTo(map);
    displayPopup({}, gps_pos , true, true);
    qth_marker.on('dragend', QTHdragend);
};

function callbkQTHNG(arg) {
    var emsg = "エラーが発生しました",
	lat = Cookies.get('my_qth_lat'),
	lng = Cookies.get('my_qth_lng'),
	zoom = 13;

    switch(arg.code) {
    case 1:
	emesg = "位置情報の利用が許可されていません";
	break;
    case 2:
	emesg = "端末位置がわかりませんでした";
	break;
    case 3:
	emesg = "タイムアウトしました";
	break;
    }
    window.alert(emesg);

    if (lat) 
	latlng = [ parseFloat(lat), parseFloat(lng)];
    else {
	latlng = [37.514444, 137.712222];
	zoom = 6;
    };
    map.setView(latlng, zoom);
};

function clickQTHButton () {
    if (typeof navigator.geolocation === 'undefined') {
	window . alert('ブラウザが位置情報取得に対応していません');
	map.setView([37.514444, 137.712222], 6);
    }

    var options = {
	"enableHighAccuracy": true,
	"timeout": 10000,
	"maximumAge": 0
    }
    navigator.geolocation.getCurrentPosition(callbkQTHOk, callbkQTHNG, options);
};

function kp_index() {
    $.getJSON(sotalive + "api/geomag",function(geomag) {
	kp = geomag.Kp[0];
	ap = geomag.Ap;
	geomagindex = 'A:'+ap +' K:' +kp;
    });
}

function clock() {
    var now = new Date();
    var tm = now.toString();
    tm  = tm.replace(/:\d{2} GMT\+.+/,'');
    var tm2 =`${now.getFullYear().toString().slice(-2)}/${("00"+(now.getMonth()+1).toString()).slice(-2)}/${("00"+now.getDate().toString()).slice(-2)} ${("00"+now.getHours().toString()).slice(-2)}:${("00"+now.getMinutes().toString()).slice(-2)}`;
    var tm3 =`${("00"+(now.getMonth()+1).toString()).slice(-2)}/${("00"+now.getDate().toString()).slice(-2)} ${("00"+now.getHours().toString()).slice(-2)}:${("00"+now.getMinutes().toString()).slice(-2)}`; 

    document.getElementById("clock_time").innerHTML='&nbsp'+ tm2 + '&nbsp' + geomagindex;
    document.getElementById("clock_time2").innerHTML='&nbsp'+ tm3;
}

function escapeStr(str) {
    var escstr;
    if (!str)
	escstr = ""
    else
	escstr = str
    var replacement = [[/&/g, "&amp;"],[/</g, "&lt;"],[/>/g, "&gt;<br>"],[/"/g, "&quot;"]]
    for(var e in replacement)
	escstr = escstr.replace(replacement[e][0],replacement[e][1]);
    escstr = escstr.replace(/<br>$/,'');
    return escstr;
}

var show_summit_marker = [];
   
function deleteSummitMarker() {
    while (show_summit_marker.length > 0) {
	var m = show_summit_marker.pop()
	map.removeLayer(m)
    }
}

var _popupMarker = null

function clearSummitMarker() {
    userChange = true
    _popupMarker = null
}

function popupSummitMarker(latlng) {
    userChange = true
    _popupMarker = latlng
}

function placeSummitMarkers(nw ,se, z) {
    var popup,elev,prefix,level;

    if (z >= prefs['zoom_threshold']) {
	elev = 0;
	level = 0;
    }
    else if (z > 9) {
	elev = 800;
	level = 1;
    }
    else if (z > 8) {
	elev = 1000;
	level = 10;
    }
    else if (z > 6) {
	elev = 1500;
	level = 20;
    }
    else {
	elev = 4000;
	level = 30;
    }
    
    prefix = 'ja?'
    
    $.getJSON(sotalive+'api/sotasummits/'+prefix,'lat='+nw[0]+'&lon='+nw[1]+'&lat2='+se[0]+'&lon2='+se[1]+'&elevation='+elev+'&park='+level +'&flag=0',function(res) {
	if (res['errors'] != 'OK') {
	    return;
	}
	if (z > 11)
	    wz = 11
	else
	    wz = z;
	
	if (prefs['sota_ref'])
	    for(const s of res['summits']) {
		var sname,
		windyuri = '<a href="https://www.windy.com/?'+ s['lat'] + ',' + s['lon'] + ',' + wz + ',d:picker" target="_blank"><img src="svg/sun.svg"><img src="svg/cloud.svg"><img src="svg/rain.svg"></a>';   
		sname = s['name_k']
		scode = '<a target="_blank" href="https://summits.sota.org.uk/summit/' + s['code'] + '">' + s['code'] + ' ' + s['name'] + '</a>'
		var mesg = '<b>'+scode+'</b><br>'+sname+'&nbsp'+s['elev']+'m,'+s['pts']+'pts (+' + s['bonus'] +')&nbsp'+ windyuri + '<br>GL:' + s['maidenhead'] + '<br>' +escapeStr(s['desc'])
		mesg += '<br>Activations: ' + s['actcnt']
		if (s['actcnt']!= 0)
		    mesg += '<br>Last Activation: ' + s['lastact'] + '(' + s['lastcall'] + ')'
		popup = false
		if (_popupMarker &&
		    s['lat'] == _popupMarker[0] &&
		    s['lon'] == _popupMarker[1]) {
		    popup = true
		    _popupMarker = null
		}
		show_summit_marker.push(
		    placeSummitMarker([s['lat'],s['lon']], z, s['elev'], s['actcnt'], mesg, popup))
		
	    }
	for(const s of res['parks']) {

	    var pname = selectRef({'pota':s['pota'],
				 'jaff':s['jaff'],
				 'name':s['name_k']}, false);
	    if (pname != '')
		show_summit_marker.push(
		    placeParkMarker([s['lat'],s['lon']], z, s))
	}
    })
}

function placeSummitMarker(coords, z, elev, actcnt, mesg, popupfl) {

    var rad;
    if (z > 14)
	rad = 10
    else if (z > 12)
	rad = 8
    else if (z > 10)
	rad = 6
    else
	rad = 4

    var fillc,
	border = "#4e342e"

    if (elev > 1500)
	fillc ="#c62828"
    else if (elev > 1100)
	fillc = "#ef6c00"
    else if (elev > 850)
	fillc = "#f9a825"
    else if (elev > 650)
	fillc = "#9e9d24"
    else if (elev > 500)
	fillc = "#558b2f"
    else
	fillc = "#1b5e20"
    
    var marker =
	L.circleMarker(coords,
		       {color: border,
			fillColor: fillc,
			radius:rad,
			weight:2,
			fillOpacity:0.8,
			opacity:1
		       });
    if (z > 11) {
	marker.bindTooltip(String(actcnt),
			   {permanent: true, direction: 'center', className: 'my-tooltip-label',offset:[0,0]})
    }
    var m = marker.addTo(map);
    
    m.on('click',function(e) {
	var l = e['target']['_latlng']
	popupSummitMarker([l['lat'],l['lng']]);
	displayActivationZone(l, -0.8);
    });
    
    if (popupfl)
	marker.bindPopup(mesg).openPopup();
    else
	marker.bindPopup(mesg)
    return m;

}

function placeParkMarker(coords, z,  parks) {

    var options = {
        prefix: 'icon'
        ,icon: 'tree'
        ,shape: 'square'
        ,markerColor: 'green-light'
        ,extraClasses: 'semantic-ui-custom'
    }, area = {
	pota : parks['pota'],
	jaff : parks['jaff'],
	name : parks['name_k']
    };
	
    var marker = L.marker(coords,{icon:L.ExtraMarkers.icon(options)}),
	mesg1 = selectRef(area, false),
	mesg2 = selectRef(area, true);
    
    marker.bindTooltip(mesg1,
		       {permanent: prefs['popup_permanent'], direction: 'center',offset:[0,20]})
    var m = marker.addTo(map);
    m.on('click',function(e) {
	displayPopup(area, e.latlng, false, false)
    });
    return m;
}

function showReference(s) {
    latlng = s['coord']
    map.setView(latlng,15);
    clearSummitMarker();
    if (s['code'].match(/JA\d*\/.+/)) {
	popupSummitMarker(s['coord'])
	displayActivationZone({'lat':s['coord'][0],'lng':s['coord'][1]}, -0.8);
    }
    redrawMarkers();
}

L.TopoJSON = L.GeoJSON.extend({
    addData: function (data) {
        var geojson, key;
        if (data.type === "Topology") {
            for (key in data.objects) {
		if (data.objects.hasOwnProperty(key)) {
                    geojson = topojson.feature(data, data.objects[key]);
                    L.GeoJSON.prototype.addData.call(this, geojson);
		}
            }
            return this;
        }
        L.GeoJSON.prototype.addData.call(this, data);
        return this;
    }
});

L.topoJson = function (data, options) {
    return new L.TopoJSON(data, options);
};

var geojson = L.topoJson(null, {
    style: function(feature){
        return {
	    color: "#000",
	    opacity: 1,
	    weight: 1,
	    fillColor: '#9fa8da',
	    fillOpacity: 0.3
        };
    },
    onEachFeature: function(feature, layer) {
	layer.on('click', function(e) {
	    displayPopup({'name':feature.properties.NAME,
			  'pota':feature.properties.POTA,
			  'jaff':feature.properties.JAFF},
			 e.latlng, false, false);
	    L.DomEvent.stop(e);
	});
	layer.on('contextmenu', function(e) {
	    displayPopup({'name':feature.properties.NAME,
			  'pota':feature.properties.POTA,
			  'jaff':feature.properties.JAFF+'('+feature.properties.UID+')'},
			 e.latlng, false, false);
	    L.DomEvent.stop(e);
	});
    }
});

geojson.addTo(map);

async function getGeoData(url) {
    let response = await fetch(url);
    let data = await response.json();
    return data;
}

getGeoData('json/jaffpota-annotated310.json').then(data => geojson.addData(data));

userChange = true;

map.on('click', function(e) {
    displayPopup({}, e.latlng, false, false);
});

map.on('dragend',function(e) {
    userChange = true
})

map.on('zoomend',function(e) {
    userChange = true
})

function placeHamFairMarker(coord) {
    var options = {
        prefix: 'icon'
        ,icon: 'star'
        ,shape: 'square'
        ,markerColor: 'pink'
	,riseOnHover: true
        ,extraClasses: 'semantic-ui-custom'
    };
    var marker = L.marker(coord,{icon:L.ExtraMarkers.icon(options)});
    marker.bindTooltip('<b><a href="https://www.jarl.org/Japanese/1_Tanoshimo/1-3_Ham-Fair/2023/" target="_blank">Ham Fair 2023</a></b>',{permanent: prefs['popup_permanent'], direction: 'center',offset:[0,20],interactive:true})
    marker.addTo(map);
}

function redrawMarkers() {
    redoActivationZone();
    deleteSummitMarker()
    var z = map.getZoom()
    var b = map.getBounds();
    placeSummitMarkers([b['_northEast']['lat'], b['_southWest']['lng']],
		       [b['_southWest']['lat'], b['_northEast']['lng']],z);
    //placeHamFairMarker([35.627288040687716, 139.79562967407333]);
}
       
map.on('moveend',function(e) {
    if (userChange) {
	userChange = false;
	redrawMarkers();
    }
});

clickQTHButton();
kp_index();
setInterval(kp_index,1000*1800);
clock();
setInterval(clock,5000);

  //Latest Spot Chart
const plugin = {
    id: 'customCanvasBackgroundColor',
    beforeDraw: (chart, args, options) => {
	const {ctx} = chart;
	ctx.save();
	ctx.globalCompositeOperation = 'destination-over';
	ctx.fillStyle = options.color || '#99ffff';
	ctx.fillRect(0, 0, chart.width, chart.height);
	ctx.restore();
    }
};

var chart = null;
var prevloc = null;
var target_prog = ['sota', 'pota'];
  
function locate_ref(loc) {
    if (loc != prevloc) {
	let url = 'https://www.sotalive.net/api/sota-jaff-pota?refid='+loc;
	fetch(url)
	    .then(res => res.json())
	    .then(data=> {
		let r = data['reference'][0];
		showReference({
		    coord:[r['lat'], r['lon']],
		    name: r['name'],
		    code: r['code'],
		})
	    });
	prevloc = loc;
    }
}

function label_callback(item, data){
    locate_ref(item.raw['ref']);
    return item.raw['z'];
}

function onProgChange(prog) {
    let drop = document.getElementById('program_dropdown');
    let prev_prog = target_prog;
    
    if (prog == 0) {
	drop.textContent = 'SOTA/POTA';
	target_prog = ['pota','sota'];
	
    } else if (prog == 1) {
	drop.textContent = 'SOTA';
	target_prog = ['sota'];

    } else if (prog == 2) {
	drop.textContent = 'POTA';
	target_prog = ['pota'];
    }
    if (prev_prog != target_prog) {
	refresh_spots();
    } 

}

function onPeriodChange(p) {
    let drop = document.getElementById('period_dropdown');
    drop.textContent = 'Last '+String(p) + 'H';
    if (prefs['spot_period'] != p) {
	prefs['spot_period'] = p;
        closePrefs();
    }
}

function refresh_spots() {
    let url = 'https://www.sotalive.net/api/sota-pota-spots?region=JA';
    if (prefs['by_call']) {
	url += '&bycall=1';
    }
    url += '&period=' + String(prefs['spot_period']);
    fetch(url)
	.then(res => res.json())
	.then(data => {
	    let datasets = [];
	    let rc = 0;
	    Object.keys(data).forEach(function(prog) {
		if (target_prog.includes(prog)) {
		    Object.keys(data[prog]).forEach(function(ref) {
			sp =[]
			for (const p of data[prog][ref]) {
			    if (prefs['by_call'])
				r = p[1];
			    else
				r = ref;
			    
			    sp.push(
				{ x : new Date(p[0]),
				  y: rc,
			      z: ref+" "+p[1]+" "+p[2]+" "+p[3]+" "+ p[4],
				  ref: r,
				})
			}
			datasets.push(
			    {label: ref,
			     data:sp});
			rc += 1;
		    });
		};
	    });

	    let ctx = document.getElementById('myChart').getContext('2d');
	    let cnt = document.getElementById('chart-container');

	    ctx.canvas.height= rc * 20 + (rc/3 + 1) * 20 ;
	    cnt.style.height = ctx.canvas.height + 40;
	    
	    if (chart) {
		chart.destroy();
	    }
	    let now = new Date();
	    let spot_from = new Date(now.getTime()- prefs['spot_period'] * 1000 * 3600);
	    let spot_to = new Date(now.getTime()+ 300 * 1000);

	    chart = new Chart(ctx, {
		type: 'line',

		data: {
		    datasets: datasets
		},
		options: {
		    responsive: true,
		    maintainAspectRatio: false,
		    elements:{
			point: {
			    pointRadius:5,
			},
		    },
		    layout: {
			padding: {
			    left:20,
			    right:20,
			}
		    },
		    plugins: {
			legend: {
			    position: 'top',
			    reverse: true,
			},
			tooltip: {
			    backgroundColor :"rgba(19, 58, 95, 09)",
			    xPading:10,
			    yPadding:10,
			    callbacks: {
				label: label_callback,
			    },
			},
			customCanvasBackgroundColor:{
			    color: 'white',
			}
		    },
		    scales: {
			x: {
			    type: 'time',
			    time: {
				unit: 'hour',
				displayFormats:{
				    'hour': 'MM/dd HH:mm',
				},
			    },
			    max : spot_to,
			    min: spot_from,
			},
			y: {
			    display: false,
			},
			
		    }
		},
		plugins:[plugin],
	    });
	    chart.update();
	});
}

  onPeriodChange(prefs['spot_period']);

  var spot_timer_id = null;
  
  $('#spots-data').on('show.bs.modal', function(e) {
      refresh_spots();
      spot_timer_id = setInterval(refresh_spots,60000);
  });
  
  $('#spots-data').on('hide.bs.modal', function(e) {
      if (spot_timer_id)
	  clearInterval(spot_timer_id);
  });
  
</script>
</body>
</html>
